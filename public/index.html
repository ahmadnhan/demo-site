<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ø­Ù…Ø¯ Ø³Ø§ÙŠØª â€” Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ±ÙˆØ§Ø¨Ø·</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="hero">
    <div class="container" style="position:relative">
      <div class="brand">
  <h1>Ø§Ø­Ù…Ø¯ Ø³Ø§ÙŠØª</h1>
        <p class="tag" data-i18n="tagline">Ù…Ø­ÙØ¸Ø© ÙˆØ±ÙˆØ§Ø¨Ø· Ø®Ø§ØµØ© â€” Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ù…Ø´Ø±ÙˆØ¹Ø§ØªÙŠ ÙˆØ±ÙˆØ§Ø¨Ø·ÙŠ Ø§Ù„Ù…Ù‡Ù…Ø©</p>
      </div>
      <!-- header controls: dark mode + language -->
      <div class="header-controls">
        <label class="hdr-switch" aria-label="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"><input type="checkbox" id="darkToggle" /><span class="icon" aria-hidden="true">ğŸŒ™</span></label>
        <select id="langSelect" aria-label="language">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="projects" class="section">
      <h2 data-i18n="projects_h2" style="text-align:center">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
      <div class="grid">
        <article class="card">
          <div class="bg"></div><div class="blob"></div>
          <div class="card-head" data-i18n="project1_title">Ø±ÙˆØ§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ÙŠ</div>
          <p class="muted" data-i18n="project1_desc">Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙ‡ Ø®Ø§ØµÙ‡ Ø¨ÙŠ</p>
          <div class="actions">
            <a class="btn btn-blue" href="https://ahmadnhan.github.io/mysite/" target="_blank" rel="noopener" data-i18n="converter_site_link" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px">Ù…ÙˆÙ‚Ø¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®</a>
          </div>
        </article>
        <article class="card">
          <div class="bg"></div><div class="blob"></div>
          <div class="card-head" data-i18n="project2_title">ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙŠ</div>
          <p class="muted">Ø±ÙˆØ§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª</p>
          <div class="actions">
            <a class="btn" href="https://www.mediafire.com/file/fekgcz3s4tl8326/app3719549-ghn059.apk/file" target="_blank" rel="noopener" data-i18n="app_converter_title" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px">ØªØ·Ø¨ÙŠÙ‚ ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ®</a>
          </div>
        </article>
      </div>
    </section>

      <!-- New: file sharing card (Ø¸Ù‡Ø± Ù‚Ø¨Ù„ ØªÙˆØ§ØµÙ„) -->
      <section id="share" class="section">
        <h2 style="text-align:center">Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„ÙØ§Øª Ø¹Ø¨Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
  <div class="card" id="shareCard">
          <div class="bg"></div><div class="blob"></div>
          <div class="card-head" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <span>Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„ÙØ§Øª Ø¹Ø¨Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
            <span id="cloudModeStatus" style="font-size:12px;padding:4px 8px;border-radius:16px;background:#f1f5f9;color:#333;letter-spacing:.5px">...ØªØ­Ù‚Ù‚</span>
          </div>
          <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· (ØªØ¬Ø±ÙŠØ¨ÙŠ). Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© ÙÙ‚Ø· ÙˆÙ„Ø§ ØªØ±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙØ¹Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±.</p>
          <div class="actions">
            <label class="btn" style="cursor:pointer">
              <input type="file" id="fileInput" style="display:none" accept="image/*,video/*" multiple />
              Ø±ÙØ¹ ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ
            </label>
            <!-- Ø­Ù‚Ù„ Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡ -->
            <!-- Ø²Ø± Ø£Ø¶Ù Ø±Ø§Ø¨Ø· ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡ -->
            
            <div id="uploadHint" class="muted" style="display:block;margin-top:8px">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø·</div>
            <div id="itemsCount" class="muted" style="display:block;margin-top:4px;font-size:12px;opacity:.8"></div>
            <div id="uploadProgress" style="display:none;width:100%;background:#e2e8f0;border-radius:6px;height:8px;margin-top:8px;overflow:hidden">
              <div id="uploadBar" style="height:100%;width:0;background:linear-gradient(90deg,#0ea5e9,#38bdf8);transition:width .2s"></div>
            </div>
          </div>
          <div id="sharePreview" class="share-preview" style="margin-top:10px"></div>
          <div id="dropZone" style="margin-top:8px;padding:18px;border:2px dashed #94a3b8;border-radius:10px;text-align:center;font-size:14px;color:#64748b;cursor:copy;">
            Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‡Ù†Ø§
          </div>
          <div id="storageHelp" style="display:none;margin-top:12px;padding:12px;border:1px solid #f59e0b;background:#fffbeb;border-radius:8px;font-size:13px;line-height:1.5;color:#92400e">
            <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØ¨Ø¯Ùˆ Ø£Ù† Firebase Storage ØºÙŠØ± Ù…ÙÙØ¹Ù„ Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ CORS ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·.<br>
            1) ÙØ¹Ù‘Ù„ Storage Ù…Ù† Ù„ÙˆØ­Ø© Firebase (Build > Storage > Get started).<br>
            2) Ø§Ù†Ø´Ø± Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯: <code>firebase deploy --only storage</code><br>
            3) Ø§Ø¶Ø¨Ø· CORS Ø¹Ø¨Ø± gsutil (bucket: <code>mysite-860da.appspot.com</code>)<br>
            4) Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© (Ctrl+F5) ÙˆØ£Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹.<br>
            Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø³ÙŠØ®ØªÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡.
          </div>
          <pre id="cloudDiag" style="direction:ltr;font-size:11px;background:#0f172a;color:#94a3b8;padding:6px;border-radius:6px;overflow:auto;max-height:140px;display:none"></pre>
        </div>
      </section>

    <section id="contact" class="section">
      <h2 data-i18n="contact_h2">ØªÙˆØ§ØµÙ„</h2>
      <div class="contact">
  <p class="muted" data-i18n="contact_text">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.</p>
        <div class="contact-info">
          <a class="email green-btn" href="mailto:ahmad14088@gmail.com" aria-label="ahmad14088@gmail.com" title="ahmad14088@gmail.com">
            <span class="mail-icon" aria-hidden="true">âœ‰ï¸</span>
          </a>
        </div>
      </div>
    </section>

    <footer class="site-footer">
  <div>Â© <span id="year"></span> <span class="site-name" data-i18n="site_name">Ø§Ø­Ù…Ø¯ Ø³Ø§ÙŠØª</span> â€” <span data-i18n="rights">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span></div>
    </footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Dark mode toggle + persistence
    const darkToggle = document.getElementById('darkToggle');
    function setDark(on){
      if(on) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      try{ localStorage.setItem('demo_dark', on ? '1' : '0') }catch(e){}
      darkToggle.checked = !!on;
    }
    darkToggle.addEventListener('change', (e)=> setDark(e.target.checked));
    // restore theme from storage
    try{ if(localStorage.getItem('demo_dark') === '1') setDark(true) }catch(e){}

    // Simple i18n
    const i18n = {
      en: {
        tagline: 'Portfolio & links â€” quick view of my projects',
        projects_h2: 'Projects',
        project1_title: 'My site links',
        project1_desc: 'My demo sites',
        project2_title: 'My apps',
        project2_desc: 'Hijri/Gregorian date converter (downloadable).',
        app_converter_title: 'Date converter app',
        contact_h2: 'Contact',
        contact_text: 'Place an email or contact form here.',
        site_name: 'Demo Site',
        rights: 'All rights reserved'
      },
      ar: {
        tagline: 'Ù…Ø­ÙØ¸Ø© ÙˆØ±ÙˆØ§Ø¨Ø· Ø®Ø§ØµØ© â€” Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ù…Ø´Ø±ÙˆØ¹Ø§ØªÙŠ ÙˆØ±ÙˆØ§Ø¨Ø·ÙŠ Ø§Ù„Ù…Ù‡Ù…Ø©',
        projects_h2: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
        project1_title: 'Ø±ÙˆØ§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ÙŠ',
        project1_desc: 'Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙ‡ Ø®Ø§ØµÙ‡ Ø¨ÙŠ',
        project2_title: 'ØªØ·Ø¨ÙŠÙ‚Ø§ØªÙŠ',
        project2_desc: 'Ù…Ø­ÙˆÙ„ ØªÙˆØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ù…ÙŠÙ„).',
        app_converter_title: 'ØªØ·Ø¨ÙŠÙ‚ ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ®',
        contact_h2: 'ØªÙˆØ§ØµÙ„',
  contact_text: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.',
  site_name: 'Ø§Ø­Ù…Ø¯ Ø³Ø§ÙŠØª',
        rights: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©'
      }
    };
    const langSelect = document.getElementById('langSelect');
    function applyLang(lang){
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(i18n[lang] && i18n[lang][key]) el.textContent = i18n[lang][key];
      });
      try{ localStorage.setItem('demo_lang', lang) }catch(e){}
    }
    langSelect.addEventListener('change', ()=>applyLang(langSelect.value));
    try{
      const saved = localStorage.getItem('demo_lang');
      if(saved){ langSelect.value = saved }
    }catch(e){}
    applyLang(langSelect.value);

    // Reveal animations using IntersectionObserver
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(ent=>{
        if(ent.isIntersecting) ent.target.classList.add('in-view');
      });
    },{threshold:0.12});
    document.querySelectorAll('.card, .section').forEach(el=>{ el.classList.add('reveal'); io.observe(el) });
    // 3D tilt
    const tiltCards = document.querySelectorAll('.card');
    tiltCards.forEach(card=>{
      card.setAttribute('data-tilt','');
      card.addEventListener('mousemove', (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left)/r.width - 0.5;
        const y = (e.clientY - r.top)/r.height - 0.5;
        card.style.transform = `rotateX(${(-y*14).toFixed(2)}deg) rotateY(${(x*14).toFixed(2)}deg) translateY(-2px)`;
      });
      card.addEventListener('mouseleave', ()=>{
        card.style.transform='';
      });
    });
  </script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    // Ø¯Ø¹Ù… Ø±ÙØ¹ Ø³Ø­Ø§Ø¨ÙŠ (Firestore + Storage) Ù…Ø¹ Fallback Ù…Ø­Ù„ÙŠ
    const FIREBASE_CFG = (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey)? window.FIREBASE_CONFIG : null;
    let firebaseDb = null;
    let firebaseStorage = null;
    let CLOUD_ACTIVE = false;
  const FORCE_CLOUD_ONLY = true; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹: Ø±ÙØ¹ Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ
  const cloudModeStatusEl = document.getElementById('cloudModeStatus');
  const itemsCountEl = document.getElementById('itemsCount');
  function setCloudBadge(txt, ok){ if(!cloudModeStatusEl) return; cloudModeStatusEl.textContent = txt; cloudModeStatusEl.style.background = ok? 'linear-gradient(90deg,#16a34a,#22c55e)' : '#f1f5f9'; cloudModeStatusEl.style.color = ok? '#fff':'#333'; }
  const REQUIRED_CFG_KEYS = ['apiKey','authDomain','projectId','storageBucket'];
  // Ø£Ø¯Ø§Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø§Ø®Ù„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ´Ø®ÙŠØµ
  function logDiag(msg){
    const diag = document.getElementById('cloudDiag');
    if(!diag) return;
    diag.style.display='block';
    const ts = new Date().toLocaleTimeString();
    diag.textContent = `[${ts}] ${msg}\n` + (diag.textContent||'');
  }

  try {
      if(FIREBASE_CFG){
        firebase.initializeApp(FIREBASE_CFG);
        firebaseDb = firebase.firestore();
        firebaseStorage = firebase.storage();
        CLOUD_ACTIVE = true;
    setCloudBadge('Ø³Ø­Ø§Ø¨ÙŠ', true);
      }
  } catch(e){ console.warn('Firebase init failed', e); setCloudBadge('Ù…Ø­Ù„ÙŠ', false); }
  if(!CLOUD_ACTIVE) setCloudBadge('Ù…Ø­Ù„ÙŠ', false);
  // ØªØ´Ø®ÙŠØµ Ù…Ø¨ÙƒØ± Ù„Ù†Ù‚Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
  window.addEventListener('DOMContentLoaded', ()=>{
    const hint = document.getElementById('uploadHint');
  const storageHelp = document.getElementById('storageHelp');
    if(!FIREBASE_CFG){
      hint && (hint.textContent = 'Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ: Ø£ÙƒÙ…Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ firebase-config.js');
    } else {
      const missing = REQUIRED_CFG_KEYS.filter(k=> !FIREBASE_CFG[k]);
      if(missing.length){
        hint && (hint.textContent = 'Ù…ÙØ§ØªÙŠØ­ Firebase Ù†Ø§Ù‚ØµØ©: ' + missing.join(', '));
      }
    }
    // ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†
    if(firebaseStorage){
      (async ()=>{
        try {
          logDiag('Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„ØªØ®Ø²ÙŠÙ† bucket='+(firebase.app().options.storageBucket||'?'));
          const testRef = firebaseStorage.ref().child('shared/__health__/probe_'+Date.now()+'.txt');
          await testRef.putString('health');
          const url = await testRef.getDownloadURL();
          logDiag('Ù†Ø¬Ø­ ÙØ­Øµ Ø§Ù„ØªØ®Ø²ÙŠÙ† âœ…');
        } catch(e){
          logDiag('ÙØ­Øµ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙØ´Ù„ âŒ code='+(e.code||'')+' msg='+(e.message||e));
          if(storageHelp) storageHelp.style.display='block';
          if(String(e.code).includes('storage/')){
            hint && (hint.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØªØ®Ø²ÙŠÙ†: '+e.code);
          }
        }
      })();
    } else {
      logDiag('Ù„Ø§ ÙŠÙˆØ¬Ø¯ firebaseStorage (ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø©)');
    }
  });

    // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const fileInput = document.getElementById('fileInput');
    const uploadHint = document.getElementById('uploadHint');
    const sharePreview = document.getElementById('sharePreview');
  // const urlInput = document.getElementById('urlInput'); (Ù…Ø­Ø°ÙˆÙ)
  // const addUrlBtn = document.getElementById('addUrlBtn'); (Ù…Ø­Ø°ÙˆÙ)
    const dropZone = document.getElementById('dropZone');
  // ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø­Ø§Ø¨Ø©

    const STORAGE_KEY = 'demo_share_items_v1';
    const MAX_PERSIST_BYTES = 2 * 1024 * 1024; // 2MB
    let items = [];

    function makeId(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8); }

  // (Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø·) ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  function saveState(){ /* Ù…Ø­Ø°ÙˆÙ */ }
  function loadState(){
    if(!CLOUD_ACTIVE){
      uploadHint.textContent = 'Ø§Ù„Ø±ÙØ¹ Ù…Ø¹Ø·Ù„: ÙØ¹Ù„ Firebase Ø£ÙˆÙ„Ø§Ù‹ (Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø·)';
      try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
      fileInput && (fileInput.disabled = true);
  // addUrlBtn ÙƒØ§Ù† ÙŠÙØ¹Ø·Ù„ Ù‡Ù†Ø§ (Ù…Ø­Ø°ÙˆÙ)
      return;
    }
    uploadHint.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...';
    try {
      firebaseDb.collection('shared_items').orderBy('updatedAtMs','desc').limit(200).onSnapshot(snap=>{
        const snapshotIds = [];
        snap.forEach(doc=>{
          const it = doc.data();
          if(!it || !it.id) return;
          snapshotIds.push(it.id);
          if(!sharePreview.querySelector(`.preview-item[data-id="${it.id}"]`)){
            renderItem(it, true); // Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          }
        });
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        sharePreview.querySelectorAll('.preview-item').forEach(node=>{ if(!snapshotIds.includes(node.dataset.id) && !node.dataset.temp) node.remove(); });
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ items
        items = [];
        snap.forEach(doc=>{ const it = doc.data(); if(it && it.id) items.push(it); });
  // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø©
  uploadHint.textContent = '';
  if(itemsCountEl) itemsCountEl.textContent = items.length>0? `${items.length} Ø¹Ù†ØµØ±` : '';
      }, err=>{
        console.warn('snapshot err', err); uploadHint.textContent='ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ';
      });
    } catch(e){ uploadHint.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©'; }
  }

  function renderItem(it, insertTop){
    const wrapper = document.createElement('div');
    wrapper.className = 'preview-item';
    wrapper.dataset.id = it.id;
    wrapper.style.padding='8px';
    wrapper.style.border='1px solid rgba(0,0,0,0.06)';
    wrapper.style.borderRadius='8px';
    wrapper.style.marginBottom='8px';
    wrapper.style.display='flex';
    wrapper.style.alignItems='center';
    wrapper.style.gap='10px';

      const info = document.createElement('div'); info.style.flex='1';
      const title = document.createElement('div'); title.textContent = it.name || it.url; title.style.fontWeight='600'; info.appendChild(title);

      const url = it.dataUrl || it.url;
  if(it.type && it.type.startsWith('image/') && url){ const img=document.createElement('img'); img.src=url; img.alt=it.name||''; img.style.maxWidth='120px'; img.style.borderRadius='6px'; img.style.objectFit='cover'; img.style.cursor='pointer'; img.onload=()=>{ try{ logDiag('ØµÙˆØ±Ø© Ù…Ø­Ù…Ù„Ø© '+(it.name||it.id)); }catch(_){} }; img.onerror=()=>{ img.style.border='2px solid #dc2626'; img.title='ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'; try{ logDiag('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© '+(it.name||it.id)); }catch(_){} }; img.onclick=()=> window.open(url,'_blank','noopener'); wrapper.appendChild(img); }
      else if(it.type && it.type.startsWith('video/') && url){ const vid=document.createElement('video'); vid.src=url; vid.controls=true; vid.style.maxWidth='160px'; vid.style.borderRadius='6px'; wrapper.appendChild(vid); }
      else { const fileIcon=document.createElement('div'); fileIcon.textContent='ğŸ“„'; fileIcon.style.fontSize='40px'; fileIcon.style.cursor='pointer'; if(url) fileIcon.onclick=()=> window.open(url,'_blank','noopener'); wrapper.appendChild(fileIcon); }

      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
      const saveBtn=document.createElement('button'); saveBtn.textContent='Ø­ÙØ¸'; saveBtn.className='btn';
      saveBtn.onclick=async ()=>{ if(!url){ uploadHint.textContent='Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø·'; return;} try{ const resp=await fetch(url); const blob=await resp.blob(); const obj=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=obj; a.download=it.name||'file'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(obj); uploadHint.textContent='ØªÙ… Ø§Ù„ØªÙ†Ø²ÙŠÙ„'; }catch(e){ window.open(url,'_blank','noopener'); } };
  const removeBtn=document.createElement('button'); removeBtn.textContent='Ø¥Ø²Ø§Ù„Ø©'; removeBtn.className='btn'; removeBtn.onclick=()=>{ wrapper.remove(); items = items.filter(x=> x.id !== it.id); saveState(); if(firebaseDb) firebaseDb.collection('shared_items').doc(it.id).delete().catch(()=>{}); if(firebaseStorage && it.storagePath){ firebaseStorage.ref().child(it.storagePath).delete().catch(()=>{}); } uploadHint.textContent='Ø­Ø°Ù'; };
      actions.appendChild(saveBtn); actions.appendChild(removeBtn);

      wrapper.appendChild(info); wrapper.appendChild(actions);
      if(insertTop && sharePreview.firstChild){
        sharePreview.insertBefore(wrapper, sharePreview.firstChild);
      } else {
        sharePreview.appendChild(wrapper);
      }
  try{ logDiag('renderItem '+it.id+' kind='+(it.kind||'file')+' type='+(it.type||'')); }catch(_){ }
    }

  async function saveMetaCloud(it){
    if(!firebaseDb) return;
    try {
      await firebaseDb.collection('shared_items').doc(it.id).set(Object.assign({}, it, {
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAtMs: Date.now()
      }));
    } catch(e){ console.warn('save meta failed', e); const diag=document.getElementById('cloudDiag'); if(diag){ diag.style.display='block'; diag.textContent='Save meta failed: '+(e.message||e); } }
  }
  function showProgress(){ const c=document.getElementById('uploadProgress'); if(c) c.style.display='block'; }
  function setProgress(p){ const b=document.getElementById('uploadBar'); if(b) b.style.width = (Math.min(100, Math.max(0, p*100))).toFixed(1)+'%'; }
  function hideProgress(){ const c=document.getElementById('uploadProgress'); if(c) c.style.display='none'; setProgress(0); }
  async function uploadFileToCloud(file, onProgress){
    if(!firebaseStorage) throw new Error('No storage');
    const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g,'_');
    const id = makeId();
    const path = `shared/${id}_${safeName}`;
    const ref = firebaseStorage.ref().child(path);
    return new Promise((resolve, reject)=>{
      const task = ref.put(file);
      task.on('state_changed', snap=>{ if(onProgress && snap.totalBytes) onProgress(snap.bytesTransferred / snap.totalBytes); }, err=> reject(err), async ()=>{ try{ const url = await task.snapshot.ref.getDownloadURL(); resolve({ url, path, id }); } catch(e){ reject(e); } });
    });
  }
  function updateCounter(){ if(itemsCountEl) itemsCountEl.textContent = items.length>0? `${items.length} Ø¹Ù†ØµØ±` : ''; }
  function createUploadingPlaceholder(file){
    const id = 'temp-'+makeId();
    const wrapper = document.createElement('div');
    wrapper.className='preview-item';
    wrapper.dataset.id = id;
    wrapper.dataset.temp = '1';
    wrapper.style.cssText='padding:8px;border:1px dashed #64748b;border-radius:8px;margin-bottom:8px;display:flex;align-items:center;gap:10px;opacity:.7;background:rgba(148,163,184,0.08)';
    // thumb
    if(file && file.type && file.type.startsWith('image/')){
      const img=document.createElement('img'); img.style.maxWidth='90px'; img.style.borderRadius='6px'; img.style.objectFit='cover'; img.alt='preview';
      const url = URL.createObjectURL(file); img.src=url; wrapper.dataset.objUrl=url; wrapper.appendChild(img);
    } else if(file && file.type && file.type.startsWith('video/')) {
      const icon=document.createElement('div'); icon.textContent = 'ğŸ¬'; icon.style.fontSize='40px'; wrapper.appendChild(icon);
    } else {
      const icon=document.createElement('div'); icon.textContent = 'â³'; icon.style.fontSize='40px'; wrapper.appendChild(icon);
    }
  const info=document.createElement('div'); info.style.flex='1';
  info.innerHTML = `<div style="font-weight:600;font-size:14px;direction:ltr">${file.name}</div><div class="up-status" style="font-size:12px;color:#64748b">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ 0%</div>`;
    wrapper.appendChild(info);
    const prog=document.createElement('div'); prog.style.cssText='width:80px;height:6px;border-radius:4px;background:#334155;overflow:hidden';
    const bar=document.createElement('div'); bar.style.cssText='height:100%;width:0;background:linear-gradient(90deg,#0ea5e9,#38bdf8);transition:width .2s'; prog.appendChild(bar); wrapper.appendChild(prog);
  const cancelBtn=document.createElement('button'); cancelBtn.textContent='Ø¥Ù„ØºØ§Ø¡'; cancelBtn.className='btn'; cancelBtn.style.padding='4px 10px'; cancelBtn.style.fontSize='11px'; wrapper.appendChild(cancelBtn);
    wrapper._bar = bar;
  wrapper._statusEl = info.querySelector('.up-status');
  wrapper._cancel = cancelBtn;
    if(sharePreview.firstChild) sharePreview.insertBefore(wrapper, sharePreview.firstChild); else sharePreview.appendChild(wrapper);
  return {id, el:wrapper, setProgress:(p)=>{ bar.style.width=(p*100).toFixed(1)+'%'; if(wrapper._statusEl) wrapper._statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ '+(p*100).toFixed(0)+'%'; }, setStatus:(t)=>{ if(wrapper._statusEl) wrapper._statusEl.textContent=t; }};
  }
  function addAndPersistItem(obj){
    if(!CLOUD_ACTIVE){ uploadHint.textContent='ØºÙŠØ± Ù…Ù…ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Firebase'; return; }
    const it = Object.assign({id: makeId()}, obj);
    // Ø¹Ø±Ø¶ ØªÙØ§Ø¤Ù„ÙŠ
    items.unshift(it);
  renderItem(it, true);
    updateCounter();
    saveMetaCloud(it);
  try{ logDiag('addAndPersistItem '+it.id+' name='+(it.name||'')); }catch(_){ }
  }

  // ØªØ®Ø²ÙŠÙ† ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Firestore Ù…Ø¨Ø§Ø´Ø±Ø© (ÙƒØ­Ù„ Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø³Ø¨Ø¨ CORS)
  async function fallbackInlineImage(file, placeholder){
    try {
      if(!firebaseDb) return false;
      if(!(file.type||'').startsWith('image/')) return false;
      if(file.size > 160*1024) { logDiag('ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¬Ù… Ø¹Ù† Ø­Ø¯ inline'); return false; }
      const fr = new FileReader();
      const dataUrl = await new Promise((res,rej)=>{ fr.onerror=()=>rej(fr.error); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); });
      const doc = { kind:'file-inline', name:file.name, type:file.type, dataUrl, inline:true };
      addAndPersistItem(doc);
      placeholder && placeholder.setStatus('Ø­ÙÙØ¸Øª Inline');
      uploadHint.textContent='ØªÙ… Ø±ÙØ¹ (Inline)';
      logDiag('Inline save for '+file.name+' size='+file.size);
      return true;
    } catch(e){ logDiag('ÙØ´Ù„ inline: '+(e.message||e)); return false; }
  }
  function handleFiles(files){
    if(!files || !files.length){ uploadHint.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª'; return; }
    if(!CLOUD_ACTIVE){ uploadHint.textContent='Firebase ØºÙŠØ± Ù…ØªØµÙ„ (Ù…Ø·Ù„ÙˆØ¨)'; return; }
    const accepted = Array.from(files).filter(f=> /^(image|video)\//.test(f.type));
    const rejected = Array.from(files).filter(f=> !/^(image|video)\//.test(f.type));
    if(rejected.length){
      uploadHint.textContent = 'ØªÙ… ØªØ¬Ø§Ù‡Ù„ '+rejected.length+' Ù…Ù„Ù (ÙŠØ³Ù…Ø­ ÙÙ‚Ø· ØµÙˆØ± ÙˆÙÙŠØ¯ÙŠÙˆ)';
    }
    accepted.forEach(async f=>{
      const placeholder = createUploadingPlaceholder(f);
      let canceled = false;
      let taskRef = null;
      let timedOut = false;
      const startTime = Date.now();
      placeholder.el._cancel.addEventListener('click', ()=>{ if(taskRef){ try{ taskRef.cancel(); }catch(_){} } canceled=true; placeholder.setStatus('Ø£ÙÙ„ØºÙŠ'); placeholder.el.style.opacity='0.4'; });
      try {
        uploadHint.textContent = `Ø±ÙØ¹ ${f.name}...`;
        const safeName = f.name.replace(/[^a-zA-Z0-9.\-_]/g,'_');
        const id = makeId();
        const path = `shared/${id}_${safeName}`;
        const ref = firebaseStorage.ref().child(path);
        const task = ref.put(f);
        taskRef = task;
  const timeoutMs = 180000; // 180 Ø«Ø§Ù†ÙŠØ© Ù…Ù‡Ù„Ø© (ØªÙ…Ø¯ÙŠØ¯ Ù„Ù„ØªØ´Ø®ÙŠØµ)
        const timeout = setTimeout(()=>{ if(!canceled){ timedOut = true; try{ task.cancel(); }catch(_){} placeholder.setStatus('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©'); } }, timeoutMs);
        let firstSnapLogged = false;
        task.on('state_changed', snap=>{
          if(!firstSnapLogged){
            logDiag(`Ø¨Ø¯Ø£ Ø§Ù„Ø±ÙØ¹ ${f.name} bytesTotal=${snap.totalBytes}`);
            firstSnapLogged = true;
          }
          if(snap.totalBytes){
            const p = snap.bytesTransferred / snap.totalBytes;
            placeholder.setProgress(p);
            if(snap.bytesTransferred>0){
              logDiag(`ØªÙ‚Ø¯Ù… ${f.name}: ${snap.bytesTransferred}/${snap.totalBytes}`);
            }
          }
        }, err=>{
          clearTimeout(timeout);
          if(canceled) return;
          console.warn('upload error', err);
          if(err && err.code === 'storage/canceled'){
            if(timedOut){
              placeholder.setStatus('Ø£ÙÙ„ØºÙŠ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù…Ù‡Ù„Ø© (Ø¨Ø·ÙŠØ¡)');
            } else if(canceled){
              placeholder.setStatus('Ø£ÙÙ„ØºÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            } else {
              placeholder.setStatus('Ø£ÙÙ„ØºÙŠ (Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø´Ø¨ÙƒØ©)');
            }
          } else {
            placeholder.setStatus('ÙØ´Ù„: '+(err.code||'Ø®Ø·Ø£'));
          }
          uploadHint.textContent='ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ';
          const diag=document.getElementById('cloudDiag'); if(diag){ diag.style.display='block'; diag.textContent='Upload error: '+(err.message||err); }
          const took = ((Date.now()-startTime)/1000).toFixed(1);
          logDiag(`Upload fail ${f.name} after ${took}s code=${err && err.code}`);
          if(/CORS|404|Failed/i.test(err.message||'')){ const sh=document.getElementById('storageHelp'); if(sh) sh.style.display='block'; }
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Inline Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„ CORS Ø£Ùˆ Ù…Ù†Ø¹ ØªØ®Ø²ÙŠÙ†
          if((err && (String(err.message).includes('CORS') || String(err.code).includes('storage/unknown') ))){
            fallbackInlineImage(f, placeholder);
          }
        }, async ()=>{
          clearTimeout(timeout);
          if(canceled) return;
          try {
            const url = await task.snapshot.ref.getDownloadURL();
            const meta = {kind:'file', name:f.name, url, type:f.type||'application/octet-stream', storagePath:path, id};
            addAndPersistItem(meta);
            placeholder.setStatus('Ø§ÙƒØªÙ…Ù„');
            setTimeout(()=>{ if(placeholder.el && placeholder.el.parentNode){ if(placeholder.el.dataset.objUrl){ try{ URL.revokeObjectURL(placeholder.el.dataset.objUrl); }catch(_e){} } placeholder.el.remove(); } }, 400);
            uploadHint.textContent = `ØªÙ… Ø±ÙØ¹ ${f.name}`;
            const took = ((Date.now()-startTime)/1000).toFixed(1);
            logDiag(`Upload ok ${f.name} in ${took}s size=${f.size}`);
          } catch(e){ console.warn('post-url error', e); placeholder.setStatus('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·'); }
        });
      } catch(e){ console.warn('cloud upload failed', e); uploadHint.textContent='ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ'; const diag=document.getElementById('cloudDiag'); if(diag){ diag.style.display='block'; diag.textContent='Cloud upload failed: '+(e.message||e); } }
    });
  }

  fileInput && fileInput.addEventListener('change', e=> handleFiles(e.target.files));

  // Drag & Drop
  if(dropZone){
    ;['dragenter','dragover'].forEach(ev=> dropZone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.style.background='rgba(14,165,233,0.08)'; }));
    ;['dragleave','drop'].forEach(ev=> dropZone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.style.background=''; }));
    dropZone.addEventListener('drop', e=>{ const dt=e.dataTransfer; if(dt && dt.files) handleFiles(dt.files); });
  }
  // Ù…Ø³ØªÙ…Ø¹ addUrlBtn Ù…Ø­Ø°ÙˆÙ
  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ© (Ù…Ø¬Ø¯Ø¯Ø§Ù‹)
  window.addEventListener('online', ()=> logDiag('ONLINE'));
  window.addEventListener('offline', ()=> logDiag('OFFLINE'));

  // ØªØ­Ù…ÙŠÙ„ (Ù„Ù† ÙŠØ¹Ø±Ø¶ Ù…Ø­Ù„ÙŠ Ø¥Ø°Ø§ FORCE_CLOUD_ONLY Ù…ÙØ¹Ù„ Ø¨Ø¯ÙˆÙ† Ø³Ø­Ø§Ø¨Ø©)
  loadState();
  </script>

</body>
</html>
